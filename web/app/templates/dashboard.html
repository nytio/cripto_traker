{% extends "base.html" %}

{% block content %}
  {% set ns = namespace(last_updated=None) %}
  {% if rows %}
    {% for row in rows %}
      {% if row.latest and row.latest.date %}
        {% if ns.last_updated is none or row.latest.date > ns.last_updated %}
          {% set ns.last_updated = row.latest.date %}
        {% endif %}
      {% endif %}
    {% endfor %}
  {% endif %}
  {% set price_prefix = '$' if currency == 'USD' else '' %}

  <div class="card shadow-sm">
    <div class="card-header bg-transparent d-flex flex-wrap align-items-center justify-content-between gap-3">
      <div>
        <h1 class="h5 fw-semibold mb-1">Dashboard</h1>
        <div class="text-muted">Portfolio overview</div>
      </div>
      <div class="d-flex flex-wrap align-items-center gap-2">
        <form method="post" action="{{ url_for('prices.update_prices') }}" data-loading="1">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <button type="submit" class="btn btn-sm btn-primary" data-loading-text="Updating..." data-loading-spinner="1">
            Update prices
          </button>
        </form>
        <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('cryptos.new_crypto') }}">
          Add crypto
        </a>
      </div>
    </div>
    <div class="card-body p-0">
      {% if rows %}
        <div class="d-flex flex-wrap align-items-center justify-content-between gap-3 p-3">
          <div>
            <h2 class="h6 fw-semibold mb-0">Tracked assets</h2>
            <div class="text-muted small">Last updated: {{ ns.last_updated if ns.last_updated else 'Not available' }}</div>
          </div>
          <div class="ct-search">
            <span class="ct-search-icon">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" aria-hidden="true" viewBox="0 0 16 16">
                <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85zm-5.242.656a5 5 0 1 1 0-10 5 5 0 0 1 0 10z"/>
              </svg>
            </span>
            <input type="text" class="form-control form-control-sm ps-5" id="asset-search" placeholder="Search name or symbol" aria-label="Search name or symbol" data-search-input data-search-target="#assets-table">
          </div>
        </div>
        <div class="table-responsive">
          <table class="table table-hover align-middle ct-table" id="assets-table">
            <thead>
              <tr>
                <th>Name</th>
                <th>Symbol</th>
                <th class="text-end">Latest price <span class="ct-meta">({{ currency }})</span></th>
                <th>Date</th>
                <th class="text-end">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for row in rows %}
                {% set name = row.crypto.name or row.crypto.coingecko_id %}
                {% set symbol = row.crypto.symbol or '' %}
                <tr data-search-text="{{ name }} {{ symbol }}">
                  <td>
                    <div class="fw-semibold">{{ name }}</div>
                  </td>
                  <td>
                    {% if symbol %}
                      <span class="badge bg-light text-dark">{{ symbol|upper }}</span>
                    {% else %}
                      <span class="text-muted">--</span>
                    {% endif %}
                  </td>
                  <td class="text-end">
                    {% if row.latest %}
                      <div class="fw-semibold ct-price">{{ price_prefix }}{{ "{:,.2f}".format(row.latest.price) }}</div>
                      <div class="ct-meta ct-price" title="{{ price_prefix }}{{ "{:,.4f}".format(row.latest.price) }}">
                        {{ price_prefix }}{{ "{:,.4f}".format(row.latest.price) }}
                      </div>
                    {% else %}
                      <span class="text-muted">--</span>
                    {% endif %}
                  </td>
                  <td class="text-nowrap text-muted">
                    {{ row.latest.date if row.latest else '--' }}
                  </td>
                  <td>
                    <div class="d-flex justify-content-end gap-2">
                      <a class="btn btn-sm btn-outline-primary" href="{{ url_for('charts.crypto_detail', crypto_id=row.crypto.id) }}" aria-label="View details" title="View details">
                        View
                      </a>
                      <button type="button" class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#remove-modal" data-remove-action="{{ url_for('cryptos.remove_crypto', crypto_id=row.crypto.id) }}" data-remove-name="{{ name }}" data-remove-symbol="{{ symbol|upper }}" aria-label="Remove crypto" title="Remove crypto">
                        Remove
                      </button>
                    </div>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="p-4 text-center">
          <div class="mb-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="currentColor" class="ct-muted" aria-hidden="true" viewBox="0 0 16 16">
              <path d="M4 0a2 2 0 0 0-2 2v10.5A3.5 3.5 0 0 0 5.5 16H14a2 2 0 0 0 2-2V5.5a.5.5 0 0 0-.146-.354l-3-3A.5.5 0 0 0 12.5 2H10a2 2 0 0 0-2-2H4zm8 3.5V2.707L14.293 5H13.5a1.5 1.5 0 0 1-1.5-1.5z"/>
            </svg>
          </div>
          <h2 class="h5 mb-2">No assets yet</h2>
          <p class="ct-meta mb-3">Add a crypto to start tracking.</p>
          <a class="btn btn-sm btn-primary" href="{{ url_for('cryptos.new_crypto') }}">Add crypto</a>
        </div>
      {% endif %}
    </div>
  </div>
{% endblock %}
