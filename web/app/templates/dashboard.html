{% extends "base.html" %}

{% block content %}
  {% set ns = namespace(last_updated=None) %}
  {% if rows %}
    {% for row in rows %}
      {% if row.latest and row.latest.date %}
        {% if ns.last_updated is none or row.latest.date > ns.last_updated %}
          {% set ns.last_updated = row.latest.date %}
        {% endif %}
      {% endif %}
    {% endfor %}
  {% endif %}
  {% set price_prefix = '$' if currency == 'USD' else '' %}

  <div class="d-flex flex-wrap align-items-center gap-3 mb-3 py-2">
    <div class="d-flex flex-column gap-1">
      <h1 class="h5 fw-semibold mb-0">Dashboard</h1>
      <div class="text-muted small">Portfolio overview</div>
    </div>
    <div class="d-flex flex-wrap align-items-center gap-2 ms-auto">
      <form method="post" action="{{ url_for('prices.update_prices') }}" data-loading="1">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <button type="submit" class="btn btn-sm btn-primary" data-loading-text="Updating..." data-loading-spinner="1">
          Update prices
        </button>
      </form>
      <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('cryptos.new_crypto') }}">
        Add crypto
      </a>
    </div>
  </div>

  <div class="card shadow-sm">
    <div class="card-body p-0">
      {% if rows %}
        <div class="d-flex flex-wrap align-items-center justify-content-between gap-3 p-3">
          <div>
            <h2 class="h6 fw-semibold mb-0">Tracked assets</h2>
            <div class="text-muted small">Last updated: {{ ns.last_updated if ns.last_updated else 'Not available' }}</div>
          </div>
          <div class="ct-search">
            <span class="ct-search-icon">
              <i class="bi bi-search" aria-hidden="true"></i>
            </span>
            <input type="text" class="form-control form-control-sm ps-5" id="asset-search" placeholder="Search name or symbol" aria-label="Search name or symbol" data-search-input data-search-target="#assets-table">
          </div>
        </div>
        <div class="table-responsive">
          <table class="table table-hover align-middle ct-table" id="assets-table">
            <thead>
              <tr>
                <th>
                  <div>Name</div>
                  <div class="ct-meta">Symbol</div>
                </th>
                <th class="text-end">
                  <div>Latest price <span class="ct-meta">({{ currency }})</span></div>
                  <div class="ct-meta">Date</div>
                </th>
                <th class="text-end">
                  <div>Bollinger</div>
                  <div class="ct-meta" title="Bollinger BandWidth">BBW</div>
                </th>
                <th class="text-end">
                  <div>Prophet</div>
                  <div class="ct-meta" title="Percentage Price Oscillator">PPO</div>
                </th>
                <th class="text-end">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for row in rows %}
                {% set name = row.crypto.name or row.crypto.coingecko_id %}
                {% set symbol = row.crypto.symbol or '' %}
                <tr data-search-text="{{ name }} {{ symbol }}">
                  <td>
                    <div class="fw-semibold">{{ name }}</div>
                    {% if symbol %}
                      <div class="small text-muted">
                        <span class="badge bg-light text-dark">{{ symbol|upper }}</span>
                      </div>
                    {% else %}
                      <div class="small text-muted">--</div>
                    {% endif %}
                  </td>
                  <td class="text-end">
                    {% if row.latest %}
                      <div class="fw-semibold ct-price">{{ price_prefix }}{{ "{:,.2f}".format(row.latest.price) }}</div>
                      <div class="text-muted small">
                        {{ row.latest.date }}
                      </div>
                    {% else %}
                      <span class="text-muted">--</span>
                    {% endif %}
                  </td>
                  <td class="text-end">
                    {% if row.bollinger_percent is not none %}
                      <div class="fw-semibold">{{ "{:.0f}".format(row.bollinger_percent * 100) }}</div>
                      {% if row.bollinger_bandwidth is not none %}
                        <div class="text-muted small">{{ "{:.2f}".format(row.bollinger_bandwidth) }}</div>
                      {% endif %}
                    {% else %}
                      <span class="text-muted">--</span>
                    {% endif %}
                  </td>
                  <td class="text-end">
                    {% if row.prophet_percent is not none %}
                      <div class="fw-semibold">{{ "{:.1f}".format(row.prophet_percent * 100) }}</div>
                      {% if row.sma_spread is not none %}
                        <div class="text-muted small">{{ "{:.2f}".format(row.sma_spread) }}</div>
                      {% endif %}
                    {% endif %}
                  </td>
                  <td>
                    <div class="d-flex justify-content-end gap-2">
                      <a class="btn btn-sm btn-outline-primary" href="{{ url_for('charts.crypto_detail', crypto_id=row.crypto.id) }}" aria-label="View details" title="View details">
                        View
                      </a>
                      <button type="button" class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#remove-modal" data-remove-action="{{ url_for('cryptos.remove_crypto', crypto_id=row.crypto.id) }}" data-remove-name="{{ name }}" data-remove-symbol="{{ symbol|upper }}" aria-label="Remove crypto" title="Remove crypto">
                        Remove
                      </button>
                    </div>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="p-4 text-center">
          <div class="mb-2">
            <i class="bi bi-coin ct-muted fs-3" aria-hidden="true"></i>
          </div>
          <h2 class="h5 mb-2">No assets yet</h2>
          <p class="ct-meta mb-3">Add a crypto to start tracking.</p>
          <a class="btn btn-sm btn-primary" href="{{ url_for('cryptos.new_crypto') }}">Add crypto</a>
        </div>
      {% endif %}
    </div>
  </div>
{% endblock %}
